<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pneubarato - 4 Pneus por R$600</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
<style>
  body { font-family: 'Poppins', sans-serif; background-color: #0A1F44; color: #f1f1f1; }
  .shadow-metal { box-shadow: 0 4px 15px rgba(255, 209, 0, 0.15); }
  .small { font-size: 0.85rem; color: #cbd5e1; }
  .btn-clear { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.06); padding: 6px 10px; border-radius: 8px; cursor: pointer; }
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:60; }
  .modal { background:#07204b; padding:24px; border-radius:12px; max-width:520px; width:95%; color:#fff; }
  .break-words { word-break: break-all; }
  .cart-badge { background:#FFD100; color:#000; font-weight:700; padding:2px 7px; border-radius:999px; font-size:0.85rem; }
  .product-card img { height:140px; object-fit:cover; border-radius:8px; }
  .btn-primary { background:#FFD100; color:#000; font-weight:700; padding:8px 12px; border-radius:8px; }
  .hidden { display:none; }
</style>
</head>
<body class="overflow-x-hidden">

<header id="header" class="fixed top-0 left-0 w-full bg-[#0F2B66]/95 backdrop-blur-md shadow-lg z-50 transition-all duration-300">
  <div class="container mx-auto flex justify-between items-center p-4 transition-all duration-300">
    <div class="flex items-center gap-3">
      <img id="logo" src="img/logo.png" alt="Pneubarato" class="h-12 transition-all duration-300">
      <h1 class="text-3xl font-extrabold text-[#FFD100] transition-all duration-300">Pneubarato</h1>
    </div>
    <nav class="space-x-6 text-sm md:text-base">
      <a href="#home" class="hover:text-[#FFD100] transition">Início</a>
      <a href="#servicos" class="hover:text-[#FFD100] transition">Serviços</a>
      <a href="#promocao" class="hover:text-[#FFD100] transition">Promoção</a>
      <a href="#galeria" class="hover:text-[#FFD100] transition">Pneus</a>
      <a href="#contato" class="hover:text-[#FFD100] transition">Contato</a>
      <button id="open-cart" class="ml-3 btn-clear">Carrinho <span id="cart-count" class="cart-badge">0</span></button>
    </nav>
  </div>
</header>

<section id="home" class="relative text-white py-32 mt-16" data-aos="fade-up">
  <img src="img/banner-pneus.jpg" alt="Pneus em destaque" class="absolute inset-0 w-full h-full object-cover opacity-25">
  <div class="relative text-center">
    <h2 class="text-5xl font-extrabold uppercase text-[#FFD100] drop-shadow-lg" data-aos="zoom-in" data-aos-delay="200">4 Pneus por R$600</h2>
    <p class="mt-4 text-lg text-gray-300" data-aos="fade-up" data-aos-delay="400">Potência, segurança e preço justo para o seu carro.</p>
    <a href="#galeria" class="inline-block mt-8 bg-[#FFD100] text-black px-10 py-4 rounded-full font-semibold text-lg hover:bg-yellow-400 transition shadow-metal" data-aos="zoom-in" data-aos-delay="600">Ver Pneus</a>
  </div>
</section>

<section id="filtros" class="py-10 bg-[#0D264D] text-center">
  <h3 class="text-3xl font-bold text-[#FFD100] mb-6 uppercase">Filtrar Pneus</h3>
  <div class="flex flex-col md:flex-row justify-center gap-4 max-w-4xl mx-auto items-center mb-8">
    <select id="filtro-aro" class="p-2 rounded-lg text-black font-semibold">
      <option value="all">Todos os Aros</option>
      <option value="13">13</option>
      <option value="14">14</option>
      <option value="15">15</option>
      <option value="16">16</option>
      <option value="17">17</option>
      <option value="18">18</option>
      <option value="19">19</option>
      <option value="20">20</option>
      <option value="21">21</option>
      <option value="22">22</option>
    </select>
    <select id="filtro-tipo" class="p-2 rounded-lg text-black font-semibold">
      <option value="all">Todos os Tipos</option>
      <option value="pirelli">Pirelli</option>
      <option value="goodyear">Goodyear</option>
      <option value="bridgestone">Bridgestone</option>
    </select>
  </div>
</section>

<section id="frete" class="py-10 bg-[#0D264D] text-center text-white">
  <h3 class="text-3xl font-bold text-[#FFD100] mb-6 uppercase">Digite seu CEP para calcular o frete</h3>
  <div class="flex flex-col md:flex-row justify-center gap-4 items-center max-w-xl mx-auto">
    <input type="text" id="cep" placeholder="Digite seu CEP" class="p-2 rounded-lg text-black font-semibold mb-4 md:mb-0">
    <input type="number" id="distancia" placeholder="Distância (KM) — opcional" min="0" step="1" class="p-2 rounded-lg text-black font-semibold mb-4 md:mb-0" />
    <button id="btn-clear-cache" class="btn-clear small" title="Limpar cache local">Limpar cache</button>
  </div>
  <p class="text-sm text-gray-300 mt-3">
    Se deixar "Distância (KM)" vazio, o sistema tentará calcular a distância automaticamente.
  </p>
  <p id="cache-info" class="small mt-2"></p>
</section>

<section id="galeria" class="py-16 bg-[#0D264D] text-center">
  <h3 class="text-3xl font-bold text-[#FFD100] mb-10 uppercase">Nossos Pneus</h3>
  <div id="galeria-pneus" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 max-w-7xl mx-auto px-6"></div>
</section>

<!-- Cart Modal -->
<div id="cart-modal" class="hidden" aria-hidden="true">
  <div class="modal-backdrop" id="cart-backdrop">
    <div class="modal">
      <h3 class="text-xl font-bold text-[#FFD100] mb-3">Seu Carrinho</h3>
      <div id="cart-body" class="mb-4"></div>
      <div class="flex justify-between items-center mt-4">
        <div>
          <span class="small">Total:</span>
          <div id="cart-total" class="text-2xl font-extrabold text-[#FFD100]">R$0,00</div>
        </div>
        <div class="flex gap-2">
          <button id="btn-close-cart" class="btn-clear">Fechar</button>
          <button id="btn-checkout" class="btn-primary">Finalizar Compra</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Checkout Modal -->
<div id="checkout-modal" class="hidden" aria-hidden="true">
  <div class="modal-backdrop" id="checkout-backdrop">
    <div class="modal">
      <h3 class="text-xl font-bold text-[#FFD100] mb-3">Finalizar Pedido</h3>
      <form id="checkout-form" class="space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <input type="text" id="buyer-name" placeholder="Nome completo" required class="p-2 rounded-lg text-black">
          <input type="email" id="buyer-email" placeholder="Email" required class="p-2 rounded-lg text-black">
          <input type="tel" id="buyer-phone" placeholder="Telefone" required class="p-2 rounded-lg text-black">
          <input type="text" id="buyer-cep" placeholder="CEP" class="p-2 rounded-lg text-black">
        </div>
        <input type="text" id="buyer-address" placeholder="Endereço completo" class="p-2 rounded-lg text-black">
        <input type="text" id="buyer-cpfcnpj" placeholder="CPF ou CNPJ (opcional)" class="p-2 rounded-lg text-black">
        <div class="flex gap-2 justify-end">
          <button type="button" id="btn-back-to-cart" class="btn-clear">Voltar</button>
          <button type="submit" class="btn-primary">Pagar via PIX</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de pagamento PIX -->
<div id="pix-modal" class="hidden" aria-hidden="true">
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <h3 class="text-xl font-bold text-[#FFD100] mb-3">Pagamento via PIX</h3>
      <div id="pix-body">
        <p id="pix-desc" class="small mb-2"></p>
        <div id="pix-qrcode" class="mb-3 text-center"></div>
        <p class="small mb-2">Chave PIX: <strong id="pix-key">1735339700</strong></p>
        <p id="pix-payload" class="small break-words"></p>
        <div class="flex gap-2 justify-center mt-4">
          <button id="btn-i-paid" class="bg-green-500 px-4 py-2 rounded text-black font-bold">Já paguei (simular)</button>
          <button id="btn-close-modal" class="btn-clear">Fechar</button>
        </div>
        <p id="pix-status" class="small mt-3"></p>
      </div>
    </div>
  </div>
</div>

<section id="contato" class="py-16 bg-[#07204b] text-center">
  <h3 class="text-3xl font-bold text-[#FFD100] mb-6 uppercase">Contato</h3>
  <p class="text-gray-300 max-w-3xl mx-auto">Tem dúvidas? Fale conosco pelo telefone ou email.</p>
</section>

<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
<!-- QR generator (Qrious) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" integrity="sha512-7n3Gg3qg0+TqVQ9f1lWgH6LJK1q2n2XoS3Vf7h6Hh8x9m8qF5kJEtISq0t9oXKz7Qb0Z+q5j2cZD0V+0x0bZxQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  AOS.init({ once: true, duration: 800 });

  // --- Sample products (you should replace images and data as needed) ---
  const products = [
    { id: 'p1', title: 'Pneu Aro 15 - Pirelli', price: 150.00, aro: 15, brand: 'pirelli', img: 'img/pneu1.jpg' },
    { id: 'p2', title: 'Pneu Aro 16 - Goodyear', price: 160.00, aro: 16, brand: 'goodyear', img: 'img/pneu2.jpg' },
    { id: 'p3', title: 'Pneu Aro 17 - Bridgestone', price: 155.00, aro: 17, brand: 'bridgestone', img: 'img/pneu3.jpg' },
    { id: 'p4', title: 'Pneu Aro 14 - Pirelli', price: 145.00, aro: 14, brand: 'pirelli', img: 'img/pneu4.jpg' },
  ];

  // Seller info (fixed)
  const SELLER_PIX_KEY = '1735339700';
  const SELLER_CNPJ = '52316278000176';
  const SELLER_NOTIFICATION_EMAIL = 'marianazarerosa66@gmail.com'; // where backend will send email

  // --- DOM references ---
  const galeria = document.getElementById('galeria-pneus');
  const filtroAro = document.getElementById('filtro-aro');
  const filtroTipo = document.getElementById('filtro-tipo');
  const cartCount = document.getElementById('cart-count');
  const openCartBtn = document.getElementById('open-cart');
  const cartModal = document.getElementById('cart-modal');
  const cartBackdrop = document.getElementById('cart-backdrop');
  const cartBody = document.getElementById('cart-body');
  const cartTotalEl = document.getElementById('cart-total');
  const btnCloseCart = document.getElementById('btn-close-cart');
  const btnCheckout = document.getElementById('btn-checkout');

  const checkoutModal = document.getElementById('checkout-modal');
  const checkoutBackdrop = document.getElementById('checkout-backdrop');
  const checkoutForm = document.getElementById('checkout-form');
  const btnBackToCart = document.getElementById('btn-back-to-cart');

  const pixModal = document.getElementById('pix-modal');
  const pixDesc = document.getElementById('pix-desc');
  const pixQrcodeContainer = document.getElementById('pix-qrcode');
  const pixPayloadEl = document.getElementById('pix-payload');
  const pixKeyEl = document.getElementById('pix-key');
  const btnIPaid = document.getElementById('btn-i-paid');
  const btnClosePix = document.getElementById('btn-close-modal');
  const pixStatus = document.getElementById('pix-status');

  // --- Cart state (localStorage) ---
  function getCart() {
    return JSON.parse(localStorage.getItem('pneubarato_cart') || '[]');
  }
  function setCart(cart) {
    localStorage.setItem('pneubarato_cart', JSON.stringify(cart));
    updateCartCount();
  }
  function updateCartCount() {
    const cart = getCart();
    const count = cart.reduce((s, p) => s + p.qty, 0);
    cartCount.textContent = count;
  }

  // Populate gallery
  function renderProducts(list) {
    galeria.innerHTML = '';
    list.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product-card bg-[#07204b] p-4 rounded-lg';
      div.innerHTML = `
        <img src="${p.img}" alt="${p.title}" class="mx-auto mb-3">
        <h4 class="font-bold text-lg">${p.title}</h4>
        <p class="small mb-2">Aro: ${p.aro} • Marca: ${p.brand}</p>
        <div class="flex justify-between items-center">
          <div class="text-xl font-extrabold text-[#FFD100]">R$${p.price.toFixed(2)}</div>
          <button class="btn-primary add-to-cart" data-id="${p.id}">Adicionar</button>
        </div>
      `;
      galeria.appendChild(div);
    });
  }

  renderProducts(products);
  updateCartCount();

  // Filtering
  function applyFilters() {
    const aro = filtroAro.value;
    const tipo = filtroTipo.value;
    const filtered = products.filter(p => {
      return (aro === 'all' || String(p.aro) === aro) &&
             (tipo === 'all' || p.brand === tipo);
    });
    renderProducts(filtered);
  }
  filtroAro.addEventListener('change', applyFilters);
  filtroTipo.addEventListener('change', applyFilters);

  // Add to cart
  document.body.addEventListener('click', (e) => {
    if (e.target.matches('.add-to-cart')) {
      const id = e.target.dataset.id;
      const prod = products.find(p => p.id === id);
      if (!prod) return;
      const cart = getCart();
      const found = cart.find(i => i.id === id);
      if (found) found.qty++;
      else cart.push({ id: prod.id, title: prod.title, price: prod.price, qty: 1 });
      setCart(cart);
      alert('Produto adicionado ao carrinho');
    }
  });

  // Open cart
  openCartBtn.addEventListener('click', () => {
    showCartModal();
  });
  btnCloseCart.addEventListener('click', () => {
    hideCartModal();
  });
  cartBackdrop.addEventListener('click', (e) => { if (e.target === cartBackdrop) hideCartModal(); });

  function showCartModal() {
    renderCart();
    cartModal.classList.remove('hidden');
  }
  function hideCartModal() {
    cartModal.classList.add('hidden');
  }

  function renderCart() {
    const cart = getCart();
    if (cart.length === 0) {
      cartBody.innerHTML = '<p class="small">Seu carrinho está vazio.</p>';
      cartTotalEl.textContent = 'R$0,00';
      return;
    }
    cartBody.innerHTML = '';
    cart.forEach(item => {
      const row = document.createElement('div');
      row.className = 'flex justify-between items-center gap-2 mb-2';
      row.innerHTML = `
        <div>
          <div class="font-semibold">${item.title}</div>
          <div class="small">Qtd: ${item.qty} • R$${item.price.toFixed(2)}</div>
        </div>
        <div class="flex gap-1">
          <button class="btn-clear decrease" data-id="${item.id}">-</button>
          <button class="btn-clear increase" data-id="${item.id}">+</button>
          <button class="btn-clear remove" data-id="${item.id}">Remover</button>
        </div>
      `;
      cartBody.appendChild(row);
    });
    const total = cart.reduce((s, i) => s + i.price * i.qty, 0);
    cartTotalEl.textContent = `R$${total.toFixed(2)}`;
  }

  // Cart manipulation (increase, decrease, remove)
  cartBody.addEventListener('click', (e) => {
    const id = e.target.dataset.id;
    if (!id) return;
    const cart = getCart();
    const idx = cart.findIndex(i => i.id === id);
    if (idx === -1) return;
    if (e.target.matches('.increase')) {
      cart[idx].qty++;
    } else if (e.target.matches('.decrease')) {
      cart[idx].qty = Math.max(1, cart[idx].qty - 1);
    } else if (e.target.matches('.remove')) {
      cart.splice(idx, 1);
    }
    setCart(cart);
    renderCart();
  });

  // Checkout flow
  btnCheckout.addEventListener('click', () => {
    hideCartModal();
    checkoutModal.classList.remove('hidden');
  });
  btnBackToCart.addEventListener('click', () => {
    checkoutModal.classList.add('hidden');
    showCartModal();
  });
  checkoutBackdrop.addEventListener('click', (e) => { if (e.target === checkoutBackdrop) checkoutModal.classList.add('hidden'); });

  // Checkout submit -> show PIX modal
  checkoutForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const buyer = {
      name: document.getElementById('buyer-name').value.trim(),
      email: document.getElementById('buyer-email').value.trim(),
      phone: document.getElementById('buyer-phone').value.trim(),
      cep: document.getElementById('buyer-cep').value.trim(),
      address: document.getElementById('buyer-address').value.trim(),
      cpfcnpj: document.getElementById('buyer-cpfcnpj').value.trim()
    };
    const cart = getCart();
    if (cart.length === 0) { alert('Carrinho vazio'); return; }
    const total = cart.reduce((s, i) => s + i.price * i.qty, 0);

    // Build a simple PIX payload (NOTE: this is not a bank-validated EMV pix string).
    // For production use, integrate with a PSP/Bank PIX API to generate a proper EMV QR code.
    const payload = {
      seller_key: SELLER_PIX_KEY,
      seller_name: 'Pneubarato',
      cnpj: SELLER_CNPJ,
      amount: total.toFixed(2),
      reference: 'Pedido-' + Date.now()
    };

    // Save checkout data temporarily in sessionStorage to be sent when payment confirmed
    const checkoutData = { buyer, cart, total, payload };
    sessionStorage.setItem('checkout_data', JSON.stringify(checkoutData));

    // Show PIX modal with QR
    pixKeyEl.textContent = SELLER_PIX_KEY;
    pixDesc.textContent = `Pague o valor de R$${total.toFixed(2)} via PIX para a chave acima. Após o pagamento, clique em "Já paguei" para notificar-nos.`;
    pixPayloadEl.textContent = JSON.stringify(payload);
    generateQr(JSON.stringify(payload));
    checkoutModal.classList.add('hidden');
    pixModal.classList.remove('hidden');
  });

  // QR generation using Qrious (simple: encodes our JSON payload as QR content)
  function generateQr(text) {
    pixQrcodeContainer.innerHTML = '';
    const canvas = document.createElement('canvas');
    pixQrcodeContainer.appendChild(canvas);
    const qr = new QRious({
      element: canvas,
      value: text,
      size: 220,
      level: 'H'
    });
  }

  // Close PIX
  btnClosePix.addEventListener('click', () => { pixModal.classList.add('hidden'); });

  // Simulate "Já paguei" — send to backend to create order, send notification email, and return tracking
  btnIPaid.addEventListener('click', async () => {
    pixStatus.textContent = 'Processando confirmação...';
    const checkoutData = JSON.parse(sessionStorage.getItem('checkout_data') || 'null');
    if (!checkoutData) {
      pixStatus.textContent = 'Dados do pedido não encontrados. Refaça o checkout.';
      return;
    }

    // Call backend API to register the order and send email notification.
    // Replace /api/order with your backend endpoint (instructions in README).
    try {
      const resp = await fetch('/api/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sellerCnpj: SELLER_CNPJ,
          notifyEmail: SELLER_NOTIFICATION_EMAIL,
          checkout: checkoutData
        })
      });
      if (!resp.ok) throw new Error('Erro na API');
      const data = await resp.json();
      pixStatus.innerHTML = `Pedido registrado: <strong>${data.orderId}</strong>.<br>Link de rastreio: <a href="${data.trackingUrl}" target="_blank" class="underline">${data.trackingUrl}</a>`;
      // clear cart
      setCart([]);
      sessionStorage.removeItem('checkout_data');
    } catch (err) {
      // Fallback: if backend not available, create a mailto as a fallback (opens user's mail client)
      pixStatus.innerHTML = 'Não foi possível contatar o servidor. Enviando email por fallback...';
      const fallbackBody = encodeURIComponent(`Pedido (fallback)\n\nDados do comprador:\nNome: ${checkoutData.buyer.name}\nEmail: ${checkoutData.buyer.email}\nTelefone: ${checkoutData.buyer.phone}\nEndereço: ${checkoutData.buyer.address}\n\nItens:\n${checkoutData.cart.map(i => `${i.qty}x ${i.title} - R$${i.price}`).join('\n')}\n\nTotal: R$${checkoutData.total.toFixed(2)}\n\nPIX key: ${SELLER_PIX_KEY}\nCNPJ vendedor: ${SELLER_CNPJ}\n\nOBS: O cliente informou que já pagou.`);
      const mailto = `mailto:${SELLER_NOTIFICATION_EMAIL}?subject=${encodeURIComponent('Novo pedido - PIX (fallback)')}&body=${fallbackBody}`;
      window.location.href = mailto;
      setTimeout(() => {
        pixModal.classList.add('hidden');
        setCart([]);
        sessionStorage.removeItem('checkout_data');
      }, 1200);
    }
  });

  // Basic cache clear for example
  document.getElementById('btn-clear-cache').addEventListener('click', () => {
    localStorage.removeItem('pneubarato_cart');
    sessionStorage.removeItem('checkout_data');
    updateCartCount();
    document.getElementById('cache-info').textContent = 'Cache limpo.';
    setTimeout(() => document.getElementById('cache-info').textContent = '', 3000);
  });

  // Basic tracking UI: user can open /track/:orderId (server serves)
  // NOTE: for real tracking integration you need a shipping provider API that uses the seller CNPJ (52316278000176).

  // For demo: prefill some images if missing
  products.forEach((p, i) => {
    // if image path doesn't exist, set a placeholder
    const img = new Image();
    img.src = p.img;
    img.onerror = () => {
      p.img = `https://via.placeholder.com/300x180.png?text=${encodeURIComponent(p.title)}`;
      renderProducts(products);
    };
  });

});
</script>

</body>
</html>